@page "/book/{Id:int}"
@using BookStore.Client.Services
@using BookStore.Core.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject HttpClient Http
@inject IJSRuntime JsRuntime
@inject CartService CartService
@inject WishlistService WishlistService
@inject WaitingListService WaitingListService
@inject NavigationManager NavManager
@inject AuthenticationStateProvider AuthStateProvider

@if (errorMessage != null)
{
    <p class="text-danger">@errorMessage</p>
}
else if (book == null)
{
    <p>Завантаження...</p>
}
else
{
    <div class="book-details-layout">

        <div class="left-side">
            <button class="favorite-btn @(isFavorite ? "active" : "")" @onclick="ToggleFavorite">
                <i class="bi @(isFavorite ? "bi-heart-fill" : "bi-heart") me-2"></i>
                @(isFavorite ? "В обраному" : "Додати в обране")
            </button>

            <img src="@book.ImageUrl"
                 onerror="this.src='/images/no-image.png'"
                 alt="@book.Title"
                 class="book-image" />
        </div>

        <div class="center-side">

            <h2 class="book-title">@book.Title</h2>

            <div class="rating-stars mb-3">
                @for (int i = 1; i <= 5; i++)
                {
                    <span class="star @(i <= Math.Round(book.AverageRating) ? "filled" : "")">★</span>
                }
                <span class="rating-count">(@book.RatingsCount)</span>
            </div>

            <p><strong>Автор:</strong> @book.AuthorName</p>
            <p><strong>Категорія:</strong> @book.CategoryName</p>
            <p><strong>Рік:</strong> @book.Year</p>
            <p><strong>Мова:</strong> @book.Language</p>
            <p><strong>Опис:</strong> @book.Description</p>

            <div class="price-block d-flex align-items-center">
                <span class="price me-3">@book.Price ₴</span>
    
                @if (book.Stock > 0)
                {
                    <span class="badge bg-success">В наявності</span>
                }
                else
                {
                    <span class="badge bg-danger">Немає в наявності</span>
                }
            </div>

            @if (book.Stock > 0)
            {
                <button class="btn-buy mt-3" @onclick="AddToCart">Купити</button>
            }
            else
            {
                <AuthorizeView>
                    <Authorized>
                        <button class="btn w-100 mt-3 @(isWaiting ? "btn-secondary" : "btn-outline-primary")" 
                                @onclick="ToggleWaiting">
                            @if (isWaiting)
                            {
                                <span><i class="bi bi-bell-fill"></i> Ви очікуєте</span>
                            }
                            else
                            {
                                <span><i class="bi bi-bell"></i> Повідомити про наявність</span>
                            }
                        </button>
                    </Authorized>
                    <NotAuthorized>
                        <button class="btn btn-outline-secondary w-100 mt-3" @onclick='() => NavManager.NavigateTo("/login")'>
                            Увійдіть, щоб стежити за ціною
                        </button>
                    </NotAuthorized>
                </AuthorizeView>
            }

            <hr />

            <h4>Моя оцінка</h4>

            <AuthorizeView>
                <Authorized>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Ваша оцінка:</label>
                        <select class="form-select w-auto"
                                value="@myRating"
                                @onchange="OnRatingChanged">
                            <option value="0">Без оцінки</option>
                            @for (int i = 1; i <= 5; i++)
                            {
                                <option value="@i">@i @(new string('⭐', i))</option>
                            }
                        </select>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <p>Для оцінки книги — <a href="/login">увійдіть</a>.</p>
                </NotAuthorized>
            </AuthorizeView>

            <hr />

            <h3>Коментарі</h3>

            @* 👇 Повідомлення про успішну відправку *@
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i> @successMessage
                    <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
                </div>
            }

            @if (comments == null)
            {
                <p>Завантаження...</p>
            }
            else if (!comments.Any())
            {
                <p>Поки що немає коментарів. Будьте першим!</p>
            }
            else
            {
                <div class="comments-list mb-4">
                    @foreach (var c in comments)
                    {
                        @RenderComment(c)
                    }
                </div>
            }

            <hr />

            <AuthorizeView>
                <Authorized>
                    <h4>Залишити коментар</h4>

                    <textarea class="form-control" @bind="newComment" placeholder="Поділіться враженнями..."></textarea>

                    <button class="btn btn-primary mt-2"
                            @onclick="() => SubmitComment(null)"
                            disabled="@isSubmitting">
                        @(isSubmitting ? "Надсилання..." : "Надіслати")
                    </button>
                </Authorized>

                <NotAuthorized>
                    <p>Щоб залишити коментар — <a href="/login">увійдіть</a>.</p>
                </NotAuthorized>
            </AuthorizeView>

        </div>

        <div class="right-side">
            <div class="delivery-box">
                <h4>Доставка</h4>
                <div class="delivery-group">
                    <div class="delivery-header" @onclick='() => Toggle("nova")'>
                        <div>
                            <span class="delivery-icon np"></span>
                            Нова Пошта
                            <div class="delivery-sub">Відправка до 7 робочих днів</div>
                        </div>
                        <span class="arrow @(opened == "nova" ? "open" : "")">⌃</span>
                    </div>

                    @if (opened == "nova")
                    {
                        <div class="delivery-content">
                            <div class="delivery-item">
                                <span class="dot"></span> Поштомат <br/>Нова Пошта
                                <span class="price free">50 грн</span>
                            </div>
                            <div class="delivery-item">
                                <span class="dot"></span> Відділення Нова Пошта
                                <span class="price">60 грн</span>
                            </div>
                            <div class="delivery-item">
                                <span class="dot"></span> Кур’єр Нова Пошта
                                <span class="price">115 грн</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private BookDetailsDto? book;
    private string? errorMessage;
    private int myRating = 0;
    private List<BookCommentDto>? comments;
    
    // Поля для коментарів
    private string newComment = ""; // Текст нового кореневого коментаря
    private string newReplyText = ""; // Текст відповіді
    private bool isSubmitting = false;
    private string? successMessage;
    
    // Для редагування/відповіді
    private int? editingCommentId = null;
    private string editingCommentText = "";
    private int? replyingToId = null; // ID коментаря, на який відповідаємо

    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; }

    private int currentUserId = 0;
    private bool userIsAdmin = false;
    
    private string opened = "";
    private bool isFavorite = false;
    private bool isWaiting = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var auth = await AuthStateTask;
            var user = auth.User;

            if (user.Identity?.IsAuthenticated ?? false)
            {
                var userIdClaim = user.FindFirst("sub")
                                  ?? user.FindFirst(ClaimTypes.NameIdentifier);

                if (userIdClaim != null)
                    int.TryParse(userIdClaim.Value, out currentUserId);

                userIsAdmin = user.IsInRole("Admin");
            }

            book = await Http.GetFromJsonAsync<BookDetailsDto>($"api/books/{Id}");
            myRating = await Http.GetFromJsonAsync<int>($"api/books/{Id}/rating");
            
            await LoadComments();
            
            var waitingIds = await WaitingListService.GetWaitingListIdsAsync();
            isWaiting = waitingIds.Contains(Id);
            var wishListIds = await WishlistService.GetWishListIds();
            isFavorite = wishListIds.Contains(Id);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private async Task LoadComments()
    {
        comments = await Http.GetFromJsonAsync<List<BookCommentDto>>($"api/books/{Id}/comments");
    }

    // --- ЛОГІКА КОМЕНТАРІВ ---

    private async Task SubmitComment(int? parentId)
    {
        // Визначаємо, який текст брати (кореневий чи відповідь)
        string textToSend = parentId == null ? newComment : newReplyText;

        if (string.IsNullOrWhiteSpace(textToSend)) return;

        isSubmitting = true;

        var dto = new CreateCommentDto 
        { 
            Comment = textToSend, 
            ParentId = parentId // Передаємо батьківський ID
        };

        var response = await Http.PostAsJsonAsync($"api/books/{Id}/comments", dto);

        if (response.IsSuccessStatusCode)
        {
            // Очищення полів
            newComment = "";
            newReplyText = "";
            replyingToId = null;
            
            // Оновлення списку
            await LoadComments();
            
            successMessage = "Ваш коментар додано! Він з'явиться для всіх після перевірки модератором.";
        }

        isSubmitting = false;
    }

    private void ToggleReplyForm(int commentId)
    {
        if (replyingToId == commentId)
            replyingToId = null;
        else
        {
            replyingToId = commentId;
            newReplyText = ""; // Очистити поле при відкритті
        }
    }

    private void StartEdit(BookCommentDto c)
    {
        editingCommentId = c.Id;
        editingCommentText = c.Comment;
        replyingToId = null; // Закрити форму відповіді, якщо відкрита
    }

    private void CancelEdit()
    {
        editingCommentId = null;
        editingCommentText = "";
    }

    private async Task SaveEdit(int commentId)
    {
        if (string.IsNullOrWhiteSpace(editingCommentText)) return;

        await Http.PutAsJsonAsync(
            $"api/books/{Id}/comments/{commentId}",
            new CreateCommentDto { Comment = editingCommentText });

        editingCommentId = null;
        editingCommentText = "";

        await LoadComments();
    }

    private async Task DeleteComment(int id)
    {
        if (await JsRuntime.InvokeAsync<bool>("confirm", "Видалити цей коментар?"))
        {
            await Http.DeleteAsync($"api/books/{Id}/comments/{id}");
            await LoadComments();
        }
    }
    
    private RenderFragment RenderComment(BookCommentDto c, int level = 0) => __builder =>
    {
        <div class="review-item p-3 border-bottom @(level > 0 ? "border-start border-3 ps-4" : "")" 
             style="margin-left: @(level * 20)px; background-color: @(level > 0 ? "#f8f9fa" : "white");">
            
            <div class="d-flex justify-content-between">
                <div>
                    <strong>@c.UserName</strong>
                    <span class="text-muted small ms-2">@c.CreatedAt.ToString("dd.MM.yyyy HH:mm")</span>

                    @* Статус модерації *@
                    @if (!c.IsApproved)
                    {
                        <span class="badge bg-warning text-dark ms-2">
                            <i class="bi bi-clock-history"></i> На перевірці
                        </span>
                    }
                </div>
                
                @* Кнопки дії *@
                <div class="d-flex gap-2">
                    @if (c.UserId == currentUserId)
                    {
                        <button class="btn btn-sm btn-link text-decoration-none p-0" @onclick="() => StartEdit(c)">Ред.</button>
                    }
                    @if (c.UserId == currentUserId || userIsAdmin)
                    {
                        <button class="btn btn-sm btn-link text-danger text-decoration-none p-0" @onclick="() => DeleteComment(c.Id)">X</button>
                    }
                </div>
            </div>

            @* Тіло коментаря або форма редагування *@
            @if (editingCommentId == c.Id)
            {
                <div class="mt-2">
                    <textarea class="form-control mb-2" @bind="editingCommentText"></textarea>
                    <button class="btn btn-sm btn-success me-1" @onclick="() => SaveEdit(c.Id)">Зберегти</button>
                    <button class="btn btn-sm btn-secondary" @onclick="CancelEdit">Скасувати</button>
                </div>
            }
            else
            {
                <p class="mt-1 mb-1 @(!c.IsApproved ? "text-muted fst-italic" : "")">@c.Comment</p>

                @* Кнопка відповісти (тільки якщо коментар схвалено) *@
                @if (c.IsApproved)
                {
                    <AuthorizeView>
                        <Authorized>
                            <button class="btn btn-sm btn-link text-decoration-none p-0 mt-1" 
                                    @onclick="() => ToggleReplyForm(c.Id)">
                                Відповісти
                            </button>
                        </Authorized>
                    </AuthorizeView>
                }
            }

            @* Форма відповіді *@
            @if (replyingToId == c.Id)
            {
                <div class="mt-2 ps-3 border-start border-primary">
                    <textarea class="form-control mb-2" @bind="newReplyText" rows="2" placeholder="Ваша відповідь..."></textarea>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" @onclick="() => SubmitComment(c.Id)">Надіслати</button>
                        <button class="btn btn-outline-secondary btn-sm" @onclick="() => replyingToId = null">Скасувати</button>
                    </div>
                </div>
            }
        </div>

        @* Рендер дочірніх коментарів *@
        @if (c.Replies != null && c.Replies.Any())
        {
            @foreach (var reply in c.Replies)
            {
                @RenderComment(reply, level + 1)
            }
        }
    };

    // --- ІНШІ МЕТОДИ (Рейтинг, Кошик і т.д.) ---

    private async Task ToggleWaiting()
    {
        var auth = await AuthStateTask;
        if (!auth.User.Identity.IsAuthenticated) { NavManager.NavigateTo("/login"); return; }
        isWaiting = !isWaiting; 
        await WaitingListService.ToggleAsync(Id); 
    }

    private async Task ToggleFavorite()
    {
        var auth = await AuthStateTask;
        if (!auth.User.Identity.IsAuthenticated) { NavManager.NavigateTo("/login"); return; }
        isFavorite = !isFavorite;
        await WishlistService.ToggleWishlistAsync(Id);
    }

    private async Task AddToCart()
    {
        await CartService.AddToCart(new BookSummaryDto
        {
            Id = book.Id, Title = book.Title, Author = book.AuthorName, Price = book.Price, ImageUrl = book.ImageUrl
        });
    }

    private async Task SetRating(int value)
    {
        myRating = value;
        await Http.PostAsJsonAsync($"api/books/{Id}/rating", new { Rating = value });
        book = await Http.GetFromJsonAsync<BookDetailsDto>($"api/books/{Id}");
    }
    
    private async Task DeleteRating()
    {
        var response = await Http.DeleteAsync($"api/books/{Id}/rating");
        if (response.IsSuccessStatusCode)
        {
            myRating = 0; 
            book = await Http.GetFromJsonAsync<BookDetailsDto>($"api/books/{Id}");
        }
    }

    private async Task OnRatingChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int selectedValue))
        {
            if (selectedValue == 0) await DeleteRating();
            else await SetRating(selectedValue);
        }
    }
    
    void Toggle(string key) { if (opened == key) opened = ""; else opened = key; }
}