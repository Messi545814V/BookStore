@using BookStore.Core.DTOs
@using BookStore.Client.Services
@inject AuthService AuthService
@inject CartService CartService 

@if (IsVisible)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1" role="dialog" @onclick="Close">
        
        <div class="modal-dialog modal-dialog-centered" role="document" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Реєстрація</h5>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="registerDto" OnValidSubmit="HandleRegistration">
                        <DataAnnotationsValidator />
                    
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">@errorMessage</div>
                        }
                    
                        <div class="form-group mb-2">
                            <label>Ім'я користувача</label>
                            <InputText class="form-control" @bind-Value="registerDto.Username" />
                            <ValidationMessage For="@(() => registerDto.Username)" />
                        </div>
                        <div class="form-group mb-2">
                            <label>Пароль</label>
                            <div class="input-group">
                                <InputText type="@(showPassword ? "text" : "password")" 
                                           class="form-control password-input" 
                                           @bind-Value="registerDto.Password" />
                   
                                <button class="btn btn-password-toggle" type="button" @onclick="() => showPassword = !showPassword">
                                    <i class="bi @(showPassword ? "bi-eye-slash" : "bi-eye")"></i>
                                </button>
                            </div>
                            <ValidationMessage For="@(() => registerDto.Password)" />
                        </div>

                        <div class="form-group mb-3">
                            <label>Підтвердіть пароль</label>
                            <div class="input-group">
                                <InputText type="@(showConfirmPassword ? "text" : "password")" 
                                           class="form-control password-input" 
                                           @bind-Value="registerDto.ConfirmPassword" />
                   
                                <button class="btn btn-password-toggle" type="button" @onclick="() => showConfirmPassword = !showConfirmPassword">
                                    <i class="bi @(showConfirmPassword ? "bi-eye-slash" : "bi-eye")"></i>
                                </button>
                            </div>
                            <ValidationMessage For="@(() => registerDto.ConfirmPassword)" />
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Зареєструватися</button>
                        </div>
                    </EditForm>

                    <div class="mt-3 text-center">
                        <span>Вже маєте акаунт? </span>
                        <button class="btn btn-link p-0 align-baseline" @onclick="SwitchToLogin">Увійти</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool IsVisible { get; set; } = false;
    private RegisterDto registerDto = new();
    private string? errorMessage;
    
    private bool showPassword = false;
    private bool showConfirmPassword = false;

    [Parameter] public EventCallback OnGoToLogin { get; set; }

    [Parameter] public EventCallback<bool> OnLoginSuccess { get; set; }

    public void Show()
    {
        IsVisible = true;
        errorMessage = null;
        showPassword = false; 
        showConfirmPassword = false;
        registerDto = new RegisterDto();
        StateHasChanged();
    }

    public void Close()
    {
        IsVisible = false;
        StateHasChanged();
    }

    private async Task SwitchToLogin()
    {
        Close();
        await OnGoToLogin.InvokeAsync();
    }

    private async Task HandleRegistration()
    {
        errorMessage = null;
        
        var (success, error) = await AuthService.RegisterAsync(registerDto);
        
        if (success)
        {
            var loginResult = await AuthService.LoginAsync(new LoginDto 
            { 
                Username = registerDto.Username, 
                Password = registerDto.Password 
            });

            if (loginResult)
            {
                await CartService.SyncGuestCartToApi();
                
                Close();
                await OnLoginSuccess.InvokeAsync(true);
            }
            else 
            {
                await SwitchToLogin();
            }
        }
        else
        {
            errorMessage = error;
        }
    }
}